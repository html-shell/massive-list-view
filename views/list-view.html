<!DOCTYPE html>

<div class='MassiveListView'>
  <div class='ScrollArea DisplayColumn'>
    <div class='Top' ></div>
    <div flex="1"></div>
  </div>
</div>

<script src="../javascripts/size-balanced-tree.js"></script>

<script >
'use strict'

window.Nil.value = {
  rowHeight: 0,
  rowTotalHeight: 0
}
let oldNodeUpdateSize = window.Node.prototype.updateSize
window.Node.prototype.updateSize = function() {
  oldNodeUpdateSize.call(this)
  this.value.rowTotalHeight = this.left.value.rowTotalHeight + this.right.value.rowTotalHeight + this.value.rowHeight
}

/**
 * Returns a random integer between min (inclusive) and max (inclusive)
 * Using Math.round() will give you a non-uniform distribution!
 */
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

window.SBTree.prototype.findRowForScrollTop = function (scrollTop) {
  if (scrollTop >= this.root.value.rowTotalHeight) {
    scrollTop = this.root.value.rowTotalHeight - 1
  }
  if (scrollTop < 0) {
    scrollTop = 0
  }
  let node = this.root;
  if (node !== window.Nil) {
    while (true) {
      if (node.left.value.rowTotalHeight > scrollTop) {
        node = node.left
      } else {
        scrollTop -= node.left.value.rowTotalHeight
        if (scrollTop < node.value.rowHeight) {
          break
        }
        scrollTop -= node.value.rowHeight
        node = node.right
      }
    }
  }
  return this.getIndex(node)
}

let tree = new window.SBTree()

const startTime = Date.now()
for (let i = 0; i < 10000; ++i) {
  const newItem = {
    rowHeight:getRandomInt(1, 1),
    data: i
  }
  newItem.rowTotalHeight = newItem.rowHeight
  tree.push(newItem)
}
console.log(`totalHeight: ${tree.root.value.rowTotalHeight} ${Date.now() - startTime}`)
const listView = document.querySelector('.MassiveListView')
const scrollArea = document.querySelector('.MassiveListView .ScrollArea')
scrollArea.style.height = tree.root.value.rowTotalHeight.toString() + 'px'
const scrollAreaTop = document.querySelector('.MassiveListView > .ScrollArea > .Top')
listView.onscroll = (event)=> {
  let nodeStartIndex = tree.findRowForScrollTop(listView.scrollTop - 1080)
  let nodeEndIndex = tree.findRowForScrollTop(listView.scrollTop + 1080 + 1080)
  console.log(`${listView.scrollTop} ${nodeStartIndex} ${nodeEndIndex}`)
  //scrollAreaTop.style.height = listView.scrollTop + 'px'
}
</script>

<style>
.MassiveListView {
  height: 500px;
  overflow-y: auto;
  width:200px;
}
.MassiveListView > .ScrollArea {
}

.ScrollArea > .Top {
}

.ItemA {
  height: 10px;
  background: #008800;
}

.ItemB {
  height: 20px;
  background: #003399;
}

.ItemC {
  height: 30px;
  background: #993300;
}

.DisplayRow {
  display: flex;
  flex-flow: row nowrap;
}
.DisplayColumn {
  display: flex;
  flex-flow: column nowrap;
}
/*set flex property for items in the box*/
.DisplayRow > [flex="1"],
.DisplayColumn > [flex="1"]
{
  position: relative;
  flex: auto; /* flex-grow: 1; flex-shrink: 1; flex-basis: auto; */
}
.DisplayRow > [flex="0"],
.DisplayColumn > [flex="0"]
{
  flex: none; /* flex-grow: 0; flex-shrink: 0; flex-basis: auto; */
}


</style>
<button>
Do test
</button>
